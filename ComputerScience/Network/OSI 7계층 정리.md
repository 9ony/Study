# OSI 7계층
OSI 7계층은 네트워크에서 통신이 일어나는 과정을 7단계로 나눈 것을 의미함

네트워크 간의 연결에 어려움이 많아 호환성의 결여를 막기 위한 것으로, ISO(국제 표준화 기구)에서는 OSI 참조모델을 제시

계층으로 나눈이유는 서로 상하구조를 가지기 때문이다. 즉, 1계층 동작하지않으면 2계층은 동작할수가없다.(Encapsulation and Decapsulation)

### OSI 7계층 그림

![image](https://user-images.githubusercontent.com/97019540/233357327-06d4fd21-8c82-492c-9a08-bbf1cb1dae14.png)



## 1계층 (Physical Layer)

> 물리적으로 연결된 두 대의 컴퓨터가 데이터를 주고받을 수 있게 해주는 계층

컴퓨터는 0과 1의 나열로 데이터를 정의한다. 그러면 통신하기 위해서 0과 1만 주고받을수 있으면 됩니다.


### 1계층 예제 그림
![image](https://user-images.githubusercontent.com/97019540/233559941-bff70cc4-0d2a-4733-bace-ca91488b2bfc.png)

위 그림처럼 캡슐화된 데이터가 1계층에 도달하면 해당 데이터를 아날로그신호로 인코딩하여 받는 쪽에서는 해당 아날로그신호를 컴퓨터가 알수 있게 해석(디코딩)하는 역할을 합니다. 두 컴퓨터간에 연결은 UTP,STP,광케이블 등등의 유선으로 연결되어 있을 수도있고 무선으로 연결되어 있을수도 있다.


__여러 컴퓨터를 연결하기 위해선?__

- 모든 전선으로 연결 ( 1 + ... + n-1 => n(n-1)/2)

    ![image](https://user-images.githubusercontent.com/97019540/233571535-633cdc20-de84-4527-a222-4dadf7df9936.png)

    <br>

    - 전선의 수가 너무 많아짐

- 허브를 통한 연결 (더미허브)

    ![image](https://user-images.githubusercontent.com/97019540/233574971-94e1ed3a-22b6-44f3-b414-5b400a466edd.png)

    - 전선의 수를 줄이는 데는 성공
    - 하지만 첫번째 컴퓨터에서 같은 네트워크의 네번째 컴퓨터로 데이터를 보내야 되면 해당 데이터가 모든 컴퓨터에 데이터를 주게된다. (원치 않은 브로드캐스팅 문제 , 목적지 구분이 안됨)
    - 보안 이슈
    - 첫번째 컴퓨터가 전송하고 있을때 다른 컴퓨터가 전송하게되면 이미 첫번째 컴퓨터가 전송경로 점유하고 있기때문에 충돌 위험 (반이중 방식)


### 물리계층 장비
- 리피터

    ![image](https://user-images.githubusercontent.com/97019540/233921966-5f1f9169-775c-49a1-bac1-9cb677849b8d.png)

    - 먼 거리를 통신할때 신호를 증폭시켜주는 장비
    - 리피터는 최대 4개로 제한되어 있다.
    - 망내에 잡음도 같이 증폭된다.

- 허브 (더미허브)

    ![image](https://user-images.githubusercontent.com/97019540/233574971-94e1ed3a-22b6-44f3-b414-5b400a466edd.png)

    - 리피터의 기능을 가지고 있음
    - 멀티포트를 지원
    - 네트워크에 컴퓨터가 3대 이상일경우 한 컴퓨터에서 신호를 보내면 같은 네트워크에 모든 컴퓨터들도 다 받게된다.
    - 네트워크내에 장치가 많을수록 부하가 심해진다.

- 랜카드

    ![image](https://user-images.githubusercontent.com/97019540/233925465-afb34a04-a083-4048-87e3-4055708cc871.png)

    - 비트열 (0과 1)을 전기 신호로 변환
    - MAC주소를 가지고 있다.

### 물리계층 역할 정리

- 데이터를 아날로그 신호로 바꾸어 전선으로 흘려 보내줌 (Encoding)

- 아날로그 신호가 들어오면 데이터로 해석함 (Decoding)

- 전송매체는 유선으로는 우리가 잘아는 케이블중 랜선(UTP케이블),광케이블 등이 있고, 광케이블 등등 무선으로는 전자기파가 있다.

- 미디어 타입, 커넥터 타입, 신호표현 방법, 즉 시그널링, 속도 등을 정의


## 2계층 (DataLink Layer)

> 같은 네트워크상에 서로 다른 두대의 컴퓨터가 연결할 수 있게 해주는 계층

1계층에서 허브의 멀티포트를 통해 여러개의 장치가 연결되었는데 한 컴퓨터에서 신호를 보내면 모든 컴퓨터에 신호가 전송되었다.
그러면 수신하는 컴퓨터에 목적지에 데이터를 전송하기 위해서 어떻게 해야될까?

2계층에서는 LAN카드(NIC)에 MAC주소를 이용하여 통신을 한다.

1계층에서 설명했던대로 각각 통신장비에 LAN카드에는 MAC주소를 가지고있다. (MAC주소는 변경이 가능하다.)



### 2계층 예제 그림

![image](https://user-images.githubusercontent.com/97019540/234534358-154ce856-a22f-4734-8482-2e95418af40e.png)


위의 그림대로 2계층에서는 같은 네트워크에 서로 다른 두대의 컴퓨터가 통신을 할수 있게 Mac주소를 이용하여 통신한다.

포트1번에 연결된 컴퓨터가 포트4번에 연견된 컴퓨터에 0011이라는 데이터가 담긴 프레임을 보낸다.

하지만 스위치는 처음에 프레임을 보낼때 출발지 MAC주소가 AA:BB:CC:DD:EE:F1이니까 포트1번에 AA:BB:CC:DD:EE:F1인것만 알고`(Learning)` 목적지주소인 ~:::::F4이 어떤 포트인지는 모른다고 가정할 때
`Flooding`이 동작하는데 이는 Mac 주소 테이블에 포트번호와 맥주소가 없을때 브로드캐스트되서 스위치에 연결된 모든 컴퓨터에 프레임을 보내고 도착지 맥주소가 자기 맥주소와 비교하여 해당 프레임을 무시한다. 즉, 컴퓨터2와 컴퓨터3은 프레임을 받게되지만 무시하게 된다.

위 그림처럼 포트4번이 스위치 MAC 주소 테이블에 저장되어 있을때에는 `Forwarding` 하게되고 도착지 맥주소가 테이블에 저장되어 있기 때문에 포트4번으로만 프레임을 전송(`Filtering`)하게 된다.

또 Mac 주소 테이블에는 `Aging` 기능도 있는데 이는 맥주소를 `Learning` 했을때 저장해놓는 시간을 정합니다. (보통 300초를 저장한다함)
즉, 스위치는 Mac주소를 영구적으로 저장하지는 않는다.


### Frmae이란?

__EthernetII 그림__

![image](https://user-images.githubusercontent.com/97019540/234534538-f1f5d2d2-6705-4633-9b0c-7fdec2b568f0.png)

위 그림처럼 2계층의 데이터단위를 Frame이라고 한다.
2계층 프로토콜로는 IEEE 802.3 , DIX 2.0 , PPP, HDLC 등등이 있는데 LAN 통신 표준은 IEEE 802.3이지만 DIX 2.0(Ethernet II)이 주로 사용되고 있다. WAN 통신 시에는 PPP가 주로 사용된다고 한다.

근거리 네트워크 통신을 LAN이라 하고 원거리 네트워크 통신을 WAN이라고 한다. 나중에 라우터와 라우터사이에 먼 거리를 통신할때 2계층에서 WAN 통신 프로토콜이 사용된다고 볼수있다.

__Ethernet Frame 구조__
- Mac Frame
    - Header
        - Mac dst : 목적지 Mac 주소 
        - Mac src : 출발지 Mac 주소
            > Mac dst와 src는 3byte씩 구분되어있음 (총 6Byte)
            > 앞의 3Byte는 OUI(제조사번호) 뒤 3Byte는 (해당 업체 랜카드 식별변호)<br>
            > OUI 24bit중에 제일 오른쪽 1bit는 Multicast와 Unicast를 표시하기위한 비트인데 `0일시 unicast 1일시 multicast를 의미`한다 (Least Significant Bit 라고함)
            > 목적지 주소 6Byte(=48bit)가 전부 1일경우 Broadcast됨

        - EtherType / Length : 상위계층의 프로토콜 타입을 표시 / LLC(Logical Link Controller) Frame 길이
            - 0000~05dc(10진수로 0~1500)이면 IEEE 802.3 프레임 포맷의 DATA영역의 길이이다
            - 0600부터(DIX2.0 프레임 포맷)는 상위 프로토콜 타입을 의미한다. (`EtherType 참고링크 : https://en.wikipedia.org/wiki/EtherType#cite_note-ethtypes-7`)

    - Data
        - 프레임의 최소크기는 64byte이고 Header의 크기는 14 (목적지주소 6,출발지 6 , type length 2)
            오류제어 필드 4Byte (FCS 4)
        - 그러면 Data영역의 크기는 64-18 = 48Byte가 되고 또 data가 48Byte보다 작을시에 Pad가 추가된다
        - Pad는 0으로 채워진값 (padding) 48Byte보다작을 시 맞추기위해 사용 

    - Trailer (CRC (Cyclic Redundancy Check = FCS))
        - Preamble과 SFD는 제외한다 (Mac Frame이 아니기때문에)
        - DA + SA + Length + DATA 영역을 계산
        - MAC Controller는 Frame을 송신하면서 동시에 CRC를 계산한 후 DATA뒤에 추가
        - 수신쪽 MAC Controller도 수신하면서 동시에 CRC 계산한 후 수신된 CRC가 일치하는지 검사하고 틀리다면 폐기

__Preamble과 SFD??__
 1. Preamble
- 송신측 과 수신측간의 송/수신 속도를 일치시키기 위한 `비트 동기 (Bit Synchronization)`
- 10101010이 7회 연속 반복되는 56bit로 구성 
    > 실제 Ethernet Frame이 시작 되기전에 Preamble을 전송해 clock동기를 맞춥니다.
 2. SFD (Start Frame Delimiter)
- Frame Bit열에서 Byte단위를 식별하는 Byte동기
- 정상적인 프레임의 내용이 시작된다는 사실을 알려주는 Frame동기
- 10101011의 8Bit로 구성
- Preamble 과 SFD는 모두 MAC Controller Chip에서 생성 된다.

> 🎇 EthernetII (DIX 2.0)은 SFD는 없고 Preamble이 64bit(8Byte)로 되어있다!<br>
> ✨ Preamble과 SFD는 Physical Layer(물리계층) Header 이다.


### 데이터링크 장비

- `브릿지` :  콜리전 도메인을 나누어주는 역할
    - 소프트웨어 기반으로 동작함
    - MAC 주소 기반으로 작동
    - 필터링을 통해 Collision Domain (충돌 영역)을 줄여준다.
    - 브릿지도 전송거리를 연장시켜주는데 전기적 신호만을 증폭시키는게 아니라 Frame을 재생성하여 전송해준다.

- `L2 스위치` : 브리지의 기능 + 전이중 통신방식, 즉, 충돌이 일어나지 않는 구조의 통신장비
    - 전이중 통신방식이란 두 대의 단말기가 데이터를 송수신하기 위해 각각 독립된 회선을 사용하는 통신 방식 (포트당 하나의 Collision Domain)
    - 하드웨어 기반으로 동작
    - Mac Address Table에 목적지 주소만 보고 Frame전송
    - 각각의 포트마다 통신속도 설정 가능

### L2 스위치 주요기능
- Mac Address Table : Port번호와 Mac Address를 매핑한 테이블 
- Learnig : 위 그림예제에서 설명했듯이 스위치는 해당 포트에서 프레임이 넘어오면 해당 포트에 연결된 Mac주소를 학습한다
- Flooding : 전송된 프레임에 도착지 Mac주소가 Mac Address Table에 없을 경우 전송받은 포트를 제외한 나머지 포트에 프레임을 전송하는것
- Forwarding : 스위치에 전달받은 도착지 Mac주소가 Mac Address Table에 있을 경우 해당 Mac주소와 일치하는 포트로 프레임을 전달하는것
- Filtering : Forwarding(전송될 포트를 제외한 나머지 포트) 과 Flooding(스위치에 프레임을 보낸 포트) 시 다른포트에 프레임이 가는것을 차단시켜주는것
- Aging : Learnig시에 매핑된 Prot번호와 Mac Address를 영구적으로 저장하지않고 제한시간을 둠 (기본 300초)

> ARP는 3계층에서 다루겠습니다!!

### 데이터링크 계층 역할 정리
<br>

- 프레이밍: 데이터 링크 계층에선 `네트워크 계층에서 받아온 데이터그램`을 `프레임 단위`로 만들고 `헤더와 트레일러를 추가`
- 흐름제어: 송수신자 간 데이터를 처리하는 속도 차이를 해결하기 위한 제어도 담당
- 오류제어: 프레임 전송 시 발생한 오류를 복원하거나 재전송
- 접근제어: 매체 상 통신 장치가 여러 개 존재할 때, 데이터 전송 여부 결정

> 데이터링크 계층 기술도 랜카드에 구현되어 있다.
> 랜카드에서 송신할 데이터를 받아 이더넷헤더와 Trailer를 붙여 MAC Frame을 만들고 동기화 비트 Preamble헤더를 추가하여 전기신호로 만들어 전송한다.



## 3계층 (Network Layer)

2계층은 같은 네트워크내에 직접 연결된 기기의 통신을 다뤗다면 3계층은 서로 다른 네트워크에 있는 기기의 통신을 도와준다.

Internet Protocol(IP)를 이용하여 통신하고 목적지의 네트워크 대역대의 라우터(종단 노드)를 찾아주는 역할을 한다.

3계층의 데이터 단위는 Packet이라 한다.

### 3계층 헤더 구조(IP Header)

![image](https://github.com/9ony/9ony/assets/97019540/e3362881-a88c-4591-934c-b03fb18157d8)
 
- Version (4 bits): IP 헤더의 버전  IPv4는 4 , IPv6는 6 <br>

- Header Length (4 bits): IP 헤더의 길이를 32비트 단위로 표시 헤더의 시작으로부터 실제 데이터의 시작까지의 길이 <br>

- Type of Service (8 bits): 서비스의 우선순위 또는 서비스의 특성을 나타냄. 주로 트래픽의 우선순위, QoS (Quality of Service) 설정 등을 지정하는데 사용<br>

- Total Length (16 bits): IP 패킷의 전체 길이를 바이트 단위로 나타냄 ( 헤더 길이 + 데이터 길이 ) <br>

- Identification (16 bits): IP 패킷의 유일성을 식별하기 위한 값 패킷 조각화(fragmentation) 및 재조립(reassembly) 과정에서 사용 <br>

- Flags (3 bits): 패킷 조각화와 관련된 플래그를 나타냅니다. 주로 패킷 조각화에 대한 제어 정보가 담겨져 있음<br>

- Fragment Offset (13 bits): 패킷 조각화에서 조각의 위치 (원본 패킷에서의 조각의 상대적인 위치를 나타냄)<br>

- Time to Live (TTL) (8 bits): 패킷의 수명을 나타내며, 네트워크를 통과할 때마다 값을 1씩 감소시킵니다. TTL이 0이 되면 패킷은 폐기됨<br>

- Protocol (8 bits): IP 패킷이 상위 계층 프로토콜 (예: TCP, UDP) 중 어떤 프로토콜을 사용하는지 나타냄 <br>

- Source Address (32 bits): 송신자의 IP 주소 <br>

- Destination Address (32 bits): 수신자의 IP 주소 <br>

- Options (변동적인 길이): 추가적인 IP 옵션 정보가 필요한 경우 사용됩니다. 이 영역은 선택 사항임 <br>

### 3계층 예제 그림

![image](https://user-images.githubusercontent.com/97019540/235298886-bbb49af2-5093-4f84-8301-146737c4d1bd.png)

> 게이트웨이 주소는 보통 관례적으로 호스트ID의 마지막번호를 쓴다고한다!!<br>
(저는 임시로 1로 줬습니다 원래는 254 host id 범위가 1~254기 때문에)

__출발지 PC에서 목적지 PC까지 통신하는 과정__

1. 출발지 PC는 목적지의 IP만 알고 MAC주소는 알지 못한다.
출발지와 목적지가 네트워크 대역이 다르기 때문에 출발지 PC는 GateWay IP주소(라우터)로 패킷을 보내게 되는데 라우터의 맥주소를 모른다고 가정하면 ARP 요청(BroadCast)을한다.

  > 이때 스위치는 2계층이므로 이더넷프레임까지만 역캡슐화를하고 브로드캐스트인걸 확인하고 전송받은 포트빼고 나머지 포트에 프레임을 전송함!!

  라우터는 ARP요청에 응답받아 Mac주소를 알려주고(`ARP Reply`) 출발지 PC는 패킷을 라우터에 전달한다. (`ARP Cache Table`에 해당 정보를 저장함)

<br>

2. 라우터 1은 해당 목적지IP를 `라우팅 테이블`을 조회하여 자신의 인터페이스중 어느 인터페이스로 전송해야 할지 결정하게된다.
    > ( 결정된 다음 인터페이스를 `Next Hop`이라 한다. )
    이를 라우팅이라하고 목적지까지 패킷을 전송하는 최적경로를 계산한다.
    >위와 마찬가지로 해당 인터페이스에 대응되는 MAC 주소를 알아내기 위해 ARP 프로토콜을 사용하고 패킷을 전송해가면서 다음 Next Hop에서 위 과정을 반복하여 라우터3까지 도착하게 된다.

<br>

3. 라우터 3은 목적지 IP가 자신의 네트워크 대역대이면, 해당 IP 주소를 가진 호스트가 자신의 네트워크 상에 있는 것이므로 패킷을 해당 호스트로 전송합니다. 이때, 라우터 C는 목적지 MAC 주소를 알기 위해 ARP 프로토콜을 사용하여 ARP 요청을 보내고, 해당 호스트로부터 ARP 응답을 받고 목적지 MAC 주소를 확인받아서 패킷 전송한다.

### 라우팅 테이블 예시

![image](https://user-images.githubusercontent.com/97019540/235845253-38955570-466e-461b-832d-aa98866fab1c.png)

> 편의상 CIDR 표기법 사용 `route print 기준`으로는 해당 네트워크주소와 서브넷마스크가 따로 적혀있음

__윈도우에서 rount print한 그림__

![image](https://user-images.githubusercontent.com/97019540/235847016-b2efc355-e036-4ba3-868d-36dd49b4e0af.png)


- 목적지 네트워크 주소 : 해당 네트워크로 가야되는 주소를 표시 (목적지 IP 와 NetMask를 AND연산한 결과값)
- GateWay : 해당 네트워크 주소로 통신을 위한 게이트웨이를 표시
- NIC : 다음 홉으로 가기위한 인터페이스를 표시 (리눅스는 해당 인터페이스명이 표시된다.)
- 홉 거리 : 해당 네트워크까지 홉의 거리를 표시 (RIP 프로토콜의 hop count)
- 메트릭 : 해당 네트워크까지 우선 순위를 매길 수 있게끔 숫자로 환산하는 값 (최적 경로 선택 기준 값)


### ARP/RARP
- ARP : IP주소를 MAC주소로 Binding,Matching 시켜주는 프로토콜    
    - ip만 알고 mac주소를 모를때 사용되는 프로토콜이다.
    - 요청을 할땐 BroadCast
    - 응답받을땐 UniCast (요청을 받은쪽에서 보낸쪽에 응답하기때문)
- RARP : ARP와 반대되는 프로토콜 Reverse ARP임. 즉, Mac만알고 ip를 모를때 사용

- GARP : 같은 네트워크내 장치들의 오류제어 목적인 프로토콜
    - 같은 네트워크 망 안에서 IP 주소 충돌을 방지하기 위해서 이미 사용되고 있는지 GARP를 통해 확인할 수 있다.
        만약 GARP에 대한 응답이 오면 'IP 주소 충돌'과 관련된 에러메시지를 사용자에게 알려준다.
    - 같은 네트워크 망 내부에 존재하는 단말들의 ARP 테이블을 갱신하는 것이다.

    - 가상 MAC을 사용하는 클러스터링, VRRP, HSRP와 같은 FHRP (Fisrt Hop Redundancy)에도 GARP가 사용된다.
        네트워크에 있는 스위치 장비의 MAC 테이블 갱신이 목적이다.

- ARP Cache Table : ARP요청 시 IP와 MAC주소가 매핑된 정보를 저장하는 테이블이다.
    - 해당 IP에 패킷은 보낼때 해당 테이블을 조회하여 매핑된 정보가 있으면 사용한다.
    - MAC Address Table과 같이 `Aging Time`이 존재함.

> ARP 헤더는 이더넷프레임과 패킷사이에 위치합니다!! 2계층 프로토콜인지 3계층 프로토콜인지 저도 헷갈려서 일단 IP를 사용하기 때문에 3계층에서 정리했습니다만, 2계층 프로토콜이라는 의견도있어서 헷갈리네요 😂

### 3계층 장비

- `라우터` : 이더넷의 범위에 있는 독립적인 네트워크들을 네트워크 계층의 기능으로 분리하며 중계하는 기능을 가진 장비
    - Routing Table이 존재함 (이웃하는 라우터와 라우팅정보를 지속적으로 제공)
    - 라우터끼리 상호연결된 복잡한 망에서 경로의 배정 및 제어를 자동적으로 수행 (Routing)
    - 최적경로중 하나의 링크가 고장나면 우회경로도 제공 
    - 허용되지 않은 트래픽을 차단하거나 거부함으로써 네트워크 보안을 유지 (패킷 필터링)

- `L3 스위치` : 랜 사이에 있는 데이터 전송을 처리하고 VLAN기능 제공
    - 스위치와 라우터의 기능을 결합
    - 라우터보다 더 빠르고 성능이 좋음


### 라우팅 프로토콜 종류

- 내부라우팅(IGP): 같은 AS내부(같은 네트워크안의 게이트웨이)의 라우팅 정보를 교환하는 프로토콜
    > RIP, IGRP, EIGRP, OSPF

- 외부라우팅(EGP): 다른 AS간(서로 다른 게이트웨이 간)의 라우팅 정보를 교환하는 프로토콜
    > BGP 

### 네트워크 계층 역할 정리

패킷 분할 및 전송: 네트워크 계층에서는 상위 계층인 전송 계층에서 전송된 데이터를 일정한 크기의 패킷으로 분할하고 이 패킷은 네트워크를 통해 전송함

논리적 주소 지정:네트워크 계층에서는 각 호스트와 라우터에는 고유한 IP 주소가 할당됨
출발지와 목적지의 논리주소를 헤더에 추가하고 논리적 주소인 IP 주소를 사용하여 통신한다.

라우팅: 패킷이 출발지에서 목적지로 전송될 때, 여러 개의 라우터를 거치면서 전달되는데 네트워크 계층에서는 라우팅 프로토콜을 사용하여 최적의 경로를 선택하고 패킷을 전달한다.

오류 제어: 패킷이 전송 중에 손상되거나 분실을 방지하는 기능
- 패킷이 폐기되거나 헤더 상에 알 수 없는 정보가 있을 때, 오류제어를 할 수 있는 보조 프로토콜인 ICMP를 제공
- 전체 데이터그램이 아닌 헤더의 훼손을 방지를 위한 CheckSum필드 추가
- CheckSum은 Hop to Hop 사이, Host to Host 간의 데이터 전송 시 데이터그램의 헤더가 변경되거나 훼손되는 것을 방지

흐름 제어: 네트워크 계층에서는 패킷의 전송 속도를 조절하여 네트워크의 혼잡을 방지하고 효율적인 데이터 전송을 유지한다.
    - 송신자가 수신자가 허용할 수 있는 만큼의 데이터만 보내도록 조절
    - 이를 위해서 수신자가 송신자에게 알리는 피드백 메커니즘 필요함

> 중요한 오류제어와 흐름제어는 상위계층에서 구현되어 있다. `네트워크 계층에서는 라우팅 기능이 핵심`이라 할수 있다.
> 네트워크 계층은 운영체제 커널에 소프트웨어적으로 구현되어 있음.

