# íŒŒì¼ ì—…ë¡œë“œ

## HTTP íŒŒì¼ ì—…ë¡œë“œ ë°©ì‹

HTTP ì›¹ í™˜ê²½ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•  ë•Œ `Formíƒœê·¸`ë¥¼ í™œìš©í•˜ì—¬ íŒŒì¼ì„ ì „ì†¡í•œë‹¤.  
ì˜ˆë¥¼ ë“¤ì–´ Formíƒœê·¸ë¥¼ í™œìš©í•˜ì—¬ ì´ë¦„,ë‚˜ì´,ë¹„ë°€ë²ˆí˜¸ì˜ íšŒì›ì •ë³´ë¥¼ ìˆ˜ì •í•œë‹¤ê³  ê°€ì •í•˜ë©´,  
```html
<form th:action method="post">
    <input name="name" type="text">
    <input name="age" type="text">
    <input name="password" type="password">
    <button type="submit">ìˆ˜ì •</button>
</form>
```
ìœ„ì˜ Formì„ ì„œë²„ì— ì „ì†¡í• ë•Œ Content-Typeì„ `application/x-www-form-urlencoded`ë°©ì‹ìœ¼ë¡œ ì „ì†¡í•˜ê²Œ ëœë‹¤.

ê·¸ëŸ¬ë©´ í•´ë‹¹ ë°ì´í„°ê°€ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì „ì†¡ë˜ëŠ”ë°,  
```text
id=1&name=í™ê¸¸ë™&age=20
```

ìœ„ì™€ ê°™ì´ `&`ë¡œ êµ¬ë¶„í•˜ë©° ê° input íƒœê·¸ì˜ nameê°’ì„ keyë¡œ `ë¬¸ìì—´`ë¡œ ì „ì†¡í•˜ê²Œ ëœë‹¤.  

í•˜ì§€ë§Œ íŒŒì¼ì„ ì—…ë¡œë“œí• ë•Œì—ëŠ” ì´ì§„ë°ì´í„°ë¡œ ì „ì†¡í•´ì•¼ í•˜ëŠ”ë° ì´ë•Œ Content-Typeì´ multipart/form-dataë¡œ ì„¤ì •í•´ì¤˜ì•¼ í•œë‹¤.  

ex ) form íƒœê·¸ì— enctype="multipart/form-data" ì¶”ê°€  
```html 
<form th:action th:object="${form}" method="post" enctype="multipart/form-data">
    id : <input name="id" th:field="*{id}"><br>
    name : <input name="name" th:field="*{name}"><br>
    age : <input name="age" th:field="*{age}"><br>
    <input type="file" name="file"><br>
    <button type="submit">ì „ì†¡</button>
</form>
```

- ì¼ë°˜ í¼ ì „ì†¡

    ![image](https://github.com/9ony/9ony/assets/97019540/7038ce38-3657-41b7-ad6b-80914c6f43f6)

- Multipart/form-data ì „ì†¡

    ![image](https://github.com/9ony/9ony/assets/97019540/9adc8153-f35d-4446-956f-9ad6b33c13eb)

__ì™œ multipartì¸ê°€?__  

id,name,ageëŠ” ì¼ë°˜ì ì¸ ë¬¸ìì—´ Typeì´ë‹¤.  
í•˜ì§€ë§Œ fileì€ binary(ì´ì§„) Typeì´ê¸° ë•Œë¬¸ì— í•´ë‹¹ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ë ¤ë©´ ë”°ë¡œë”°ë¡œ Content-Typeì„ ëª…ì‹œí•´ì¤˜ì„œ ë³´ë‚´ì£¼ì–´ì•¼ í•œë‹¤.  
ì‹¤ì œë¡œ ì „ì†¡ì‹œ ë°ì´í„°ëŠ” ì•„ë˜ì™€ ê°™ì´ ì „ì†¡ëœë‹¤.  

- Reqeust ì½˜ì†” ì¶œë ¥ê°’
    ```text
    Host: localhost:8096
    Connection: keep-alive
    Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7fFFKBCrq6j83SbL
    Accept-Language: ko,en;q=0.9,en-US;q=0.8(ì¼ë¶€ìƒëµ)
    \r\n
    ------WebKitFormBoundary7fFFKBCrq6j83SbL
    Content-Disposition: form-data; name="id"
    \r\n
    1
    ------WebKitFormBoundary7fFFKBCrq6j83SbL
    Content-Disposition: form-data; name="name"
    \r\n
    Ã­Â™ÂÃªÂ¸Â¸Ã«ÂÂ™
    ------WebKitFormBoundary7fFFKBCrq6j83SbL
    Content-Disposition: form-data; name="age"
    \r\n
    10
    ------WebKitFormBoundary7fFFKBCrq6j83SbL
    Content-Disposition: form-data; name="file"; filename="TEST.png"
    Content-Type: image/png
    \r\n
    Â‰PNG
    
    IHDR  Ã¸     Â¼&Ã   sRGB Â®ÃÃ©   gAMA  Â±ÂÃ¼a   	pHYs  Ãƒ  ÃƒÃ‡oÂ¨d  Â±IDATx^Ã­Ã]vÃšHFÃ‘ÂŒÂ‹1FÃƒdLÂ·Ã€Â¤Â·Â–.Â–tÃ½Â±Ã·cÃ¼Â£rÂ‰ÂµÃªÂ¤JÃ˜Â¿Ã¾%t Â€XB Âˆ%t Â€XB Âˆ%t Â€XB Âˆ%t Â€XB Âˆ%t Â€XB Âˆ%t
    ...ì´ì§„ ë°ì´í„°(ì¼ë¶€ ìƒëµ) 
    ------WebKitFormBoundary7fFFKBCrq6j83SbL--
    ```

ì´ë ‡ê²Œ multupary/form-data ë°©ì‹ì€ ë‹¤ë¥¸ì¢…ë¥˜ì˜ ë°ì´í„°ë¥¼ í•¨ê»˜ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.  
ì¶œë ¥ëœ Body ë°ì´í„°ë¥¼ ë³´ë©´ ------WebKitFormBoundaryXXX(ëœë¤ê°’)ë¡œ êµ¬ë¶„ì§“ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆëŠ”ë°, 
ì´ë•Œ í—¤ë”ì •ë³´ì— boundary=----WebKitFormBoundary7fFFKBCrq6j83SbLì™€ ì¼ì¹˜í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  

ì´ëŠ” multipartë¡œ ìš”ì²­í•œ í•©ì³ì§„ ë°ì´í„°ë¥¼ Partë³„ë¡œ êµ¬ë¶„ì§“ê¸° ìœ„í•¨ì´ê³ ,ë¬¸ìì™€ ê²¹ì¹  ì¼ì´ ì—†ê²Œ `XXX ë¶€ë¶„ì„` ëœë¤í•œ ê°’ìœ¼ë¡œ ì¤€ë‹¤.  
íŒŒì¼ì„ ì „ì†¡í•˜ëŠ” ë¶€ë¶„ì—ëŠ” `Content-Type: image/png` ê°€ ì¶”ê°€ëœê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
ë˜ êµ¬ë¶„ëœ ê°ê°ì˜ í•˜ìœ„ ë°ì´í„° ë°”ë””ë¥¼ ë³´ë©´ Entity Header(Content-Type,Content-Disposition)ì™€ ë°”ë””ë¥¼ êµ¬ë¶„ì§“ëŠ” ê°œí–‰ë¬¸ì(`\r\n`)ê°€ ë“¤ì–´ê°„ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
ì´ë ‡ê²Œ ë°”ë””ì•ˆì— ì¶”ê°€ì ìœ¼ë¡œ boundaryë¥¼ í†µí•´ Partë¥¼ ì—¬ëŸ¬ê°œë¡œ ë‚˜ëˆ„ê³  Partë‹¹ Entity í—¤ë”ì™€ ë°”ë””ê°€ êµ¬ì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  

ì´ë ‡ê²Œ multipart/form-data í˜•ì‹ì€ ë‹¤ë¥¸ Content-Typeì˜ ë°ì´í„°ë¥¼ í•œ ìš”ì²­ì— ì—¬ëŸ¬ê°œ ë¶€ë¶„ì ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë³´ë‚´ëŠ” ê²ƒì´ë‹¤.   

`Content-Disposition` í—¤ë”ëŠ” ë©€í‹°íŒŒíŠ¸ì—ì„œëŠ” í•´ë‹¹ íŒŒíŠ¸ë³„ ë³¸ë¬¸ ë‚´ì˜ í•„ë“œì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•˜ê³ , ë˜ íŒŒì¼ ìš”ì²­ ì‹œ í•´ë‹¹ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•´ì¤„ë•Œë„ í•´ë‹¹ í—¤ë”ê°€ ì“°ì¸ë‹¤.  
ìì„¸í•œ ì •ë³´ëŠ” í•´ë‹¹ [Content-Disposition](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Content-Disposition) ë§í¬ë¥¼ í´ë¦­í•´ì„œ ì•Œì•„ë³´ì.   

## Multipart/form-data ì²˜ë¦¬ ì˜ˆì œ

- __Controller ì½”ë“œ__  
    ```java
    @GetMapping("/upload")
    public String newFile() {
        return "upload-form";
    }

    @PostMapping("/upload")
    public String saveFileV1(HttpServletRequest request) throws ServletException, IOException {
        log.info("request={}", request);
        String itemName = request.getParameter("itemName");
        log.info("itemName={}", itemName);
        Collection<Part> parts = request.getParts();
        //request.getParts()ì„ í†µí•´ multipartë¡œ ë¶€ë¶„ì ìœ¼ë¡œ ë“¤ì–´ì˜¨ ë°ì´í„°ë¥¼ Collectionìœ¼ë¡œ ë°›ëŠ”ë‹¤.
        log.info("parts={}", parts);
        return "upload-form";
    }
    ```
- í˜¸ì¶œ ê²°ê³¼
    ```log
    request=org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@777e3db1
    itemName=TEST
    parts=[org.apache.catalina.core.ApplicationPart@1b90bd2b, org.apache.catalina.core.ApplicationPart@75129300]
    ```


### multipart/form-data ìŠ¤í”„ë§ë¶€íŠ¸ ì˜µì…˜ ì„¤ì •

application.properties íŒŒì¼ì—ì„œ multipartì„¤ì •ì„ í•  ìˆ˜ìˆëŠ”ë°, ì—…ë¡œë“œ í¬ê¸° ì œí•œ, ì—…ë¡œë“œ ê²½ë¡œ, multipartìš”ì²­ ì²˜ë¦¬ ìœ ë¬´ ë“±.. ì˜µì…˜ ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤.  
[multipart/form-data ì˜µì…˜ì„¤ì •](https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/web/servlet/MultipartProperties.html)  

- __multipart ê´€ë ¨ properties ì„¤ì •ê°’__  
    
    ```properties
    # ì‚¬ì´ì¦ˆë¥¼ ë„˜ìœ¼ë©´ SizeLimitExceededExceptionì´ ë°œìƒ
    # ë‹¨ì¼ ì—…ë¡œë“œ ì‚¬ì´ì¦ˆ ì œí•œ
    spring.servlet.multipart.max-file-size=1MB

    # ì´ ì—…ë¡œë“œ ì‚¬ì´ì¦ˆ ì œí•œ
    spring.servlet.multipart.max-request-size=10MB

    # multipart/form-data ì²˜ë¦¬ ìœ ë¬´ ê¸°ë³¸ê°’ì€ true(ì²˜ë¦¬ O)
    #spring.servlet.multipart.enabled = false => multipart ìš”ì²­ì„ ì²˜ë¦¬ ì•ˆí•¨

    # íŒŒì¼ì´ ë©”ëª¨ë¦¬ì— ê¸°ë¡ë˜ëŠ” ì„ê³„ê°’ (default: 0B)
    # ì—…ë¡œë“œ íŒŒì¼ì˜ ì„ì‹œ íŒŒì¼ì„ ìƒì„±í•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì—ì„œ ë°”ë¡œ ì „ë‹¬ë˜ëŠ” í¬ê¸° ì„¤ì •
    spring.servlet.multipart.file-size-threshold = 2KB

    # ì„ì‹œíŒŒì¼ ìƒì„± ì²˜ë¦¬ë¥¼ ëŠë¦¬ê²Œ ì²˜ë¦¬í•˜ëŠ” ì˜µì…˜ (default=false)
    # í•´ë‹¹ ì˜µì…˜ì„ trueë¡œ ì„¤ì • ì‹œ Requestì˜ parseParts()ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ì´ìƒ ì„ì‹œíŒŒì¼ì´ ìƒì„±ì•ˆëœë‹¤.
    # falseê°’ ì‹œ multipartrequestê°ì²´ ìƒì„± ì‹œ ì„ì‹œíŒŒì¼ì„ ìƒì„±í•¨(ë‚´ë¶€ì ìœ¼ë¡œ parseParts()ì„ í˜¸ì¶œ)
    spring.servlet.multipart.resolve-lazily=true

    # ì—…ë¡œë“œëœ íŒŒì¼ì˜ ì„ì‹œ ì €ì¥ ê²½ë¡œ ì„¤ì •
    spring.servlet.multipart.location = C://Users/User/TEST
    ```

- spring.servlet.multipart.enabled ì„¤ì •ì— ë”°ë¥¸ ê²°ê³¼ ì°¨ì´   
    MultiPartì²˜ë¦¬ë¥¼ í• ì§€ ë§ì§€ ì„¤ì • ìœ ë¬´  
    - __true ì¼ ê²½ìš°__   
        ```log
        request=org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@777e3db1
        itemName=TEST
        parts=[org.apache.catalina.core.ApplicationPart@1b90bd2b, org.apache.catalina.core.ApplicationPart@75129300]
        ```

        trueë¡œ ì„¤ì • ì‹œ ê¸°ì¡´ ReqeustFacadeê°€ ì•„ë‹Œ StandardMultipartHttpServletRequest ê°ì²´ë¡œ ë°”ë€ê²ƒì„ ë³¼ ìˆ˜ ìˆìŒ  

    - __false ì¼ ê²½ìš°__   

        ```log
        request=org.apache.catalina.connector.RequestFacade@31be1867
        itemName=null
        parts=[]
        ```

        falseë¡œ í–ˆì„ê²½ìš° ê¸°ì¡´ì— reqeustê°ì²´ì¸ RequestFacadeì¸ë°, itemNameê³¼ Partsê°€ ë¹„ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
        ì¦‰. multipart/form-dataë¡œ ë„˜ì–´ì˜¤ëŠ” ë³µì¡í•œ ì²˜ë¦¬ë¥¼ ì•ˆí•˜ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.  

- spring.servlet.multipart.resolve-lazily ì„¤ì • ì˜µì…˜  

    Part ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì ì„ ê²°ì •í•˜ëŠ” ì˜µì…˜

    - __true ì¼ ê²½ìš°__  
        MultipartHttpServletRequest ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì ì— Partì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ì¶”í›„ reqeustì—ì„œ ê°’ì„ ê°€ì ¸ì˜¬ë•Œ parseParts()ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ë’¤ëŠ¦ê²Œ ìƒì„±í•œë‹¤.  
    - __false ì¼ ê²½ìš°__  
        doDispatch()ì—ì„œ MultipartHttpServletRequest ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ Partì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.
    
    ì¦‰, í•¸ë“¤ëŸ¬ í˜¸ì¶œ ì „ MultipartHttpServletRequest ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ Partì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ë ¤ë©´ falseë¡œ ì˜µì…˜ì„ ì£¼ê³  í•¸ë“¤ëŸ¬ì—ì„œ Partì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„± ì‹œ trueë¡œ ì˜µì…˜ì„ ì£¼ë©´ëœë‹¤.  

    â— handlerí˜¸ì¶œ ì „ì— Partì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê²Œ ëœë‹¤ë©´ multipart ê´€ë ¨ Exceptionì´ handlerí˜¸ì¶œì „ì— ë°œìƒí•˜ë¯€ë¡œ @ExceptionHandlerë¥¼ í†µí•´ ì˜ˆì™¸ë¥¼ ì¡ê¸° í˜ë“¤ì–´ ì§„ë‹¤.  

### MultipartResolver  

ìœ„ ê²°ê³¼ ì²˜ëŸ¼ `spring.servlet.multipart.enabledê°€ true`ì¼ ê²½ìš° reqeustê°ì²´ê°€ `StandardMultipartHttpServletRequest`ë¡œ ë³€í•œê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
DispatcherServletì—ì„œ request ìš”ì²­ì´ multipart/form-dataì¼ ê²½ìš° MultipartResolverë¥¼ ì‹¤í–‰í•˜ì—¬ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ì „ë‹¬í•˜ëŠ” ì¼ë°˜ì ì¸ HttpServletRequest ë¥¼ MultipartHttpServletRequest Objectë¡œ ê°ì‹¸ì„œ ë°˜í™˜í•˜ë©´ì„œ multipartì˜ ë³µì¡í•œ ì²˜ë¦¬ë¥¼ í•´ì£¼ëŠ” ê²ƒì´ë‹¤.  

- __MultipartResolver ë™ì‘ íë¦„__
    1. DispatcherServletì´ doDispatch()ì—ì„œ checkMultipart(request)ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.  
    
    2. ë©€í‹°íŒŒíŠ¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë¹ˆ ì²´í¬ ë° ìš”ì²­ì´ ë©€í‹°íŒŒíŠ¸ì¸ì§€ í™•ì¸  
    ```java
    if(this.multipartResolver != null && this.multipartResolver.isMultipart(request){...}
    ``` 
    MultipartResolver ê°ì²´ê°€ ìˆëŠ”ì§€ ì²´í¬(ë¹ˆ ë“±ë¡ ì—¬ë¶€ì²´í¬)  
    ë‹¨, ìŠ¤í”„ë§ë¶€íŠ¸ê°€ ì•„ë‹Œ `ìŠ¤í”„ë§MVCì˜ ê²½ìš° MultipartResolverì˜ êµ¬í˜„ì²´ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡`í•´ì•¼í•œë‹¤.  
    ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” `StandardServletMultipartResolver`ê°€ ê¸°ë³¸ìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆë‹¤.  
    [MultipartAutoConfiguration ê¸°ë³¸ ë“±ë¡ ì½”ë“œ](https://github.com/spring-projects/spring-boot/blob/v2.7.1/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/web/servlet/MultipartAutoConfiguration.java)

    DispatcherServlet.doDispatch()ëŠ” multipart/form-data ìš”ì²­ì¸ì§€ `this.multipartResolver.isMultipart()`ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ í™•ì¸   
    ì´ë•Œ trueë¥¼ ë°˜í™˜í•˜ë©´ í•´ë‹¹ ìš”ì²­ì€ `POST , content-type="multipart/form-data"` ì´ë‹¤.  

    3. MultipartHttpServletRequestë¡œ ë°˜í™˜ì‘ì—…  
    ```java
        // requestê°ì²´ê°€ MultipartHttpServletRequestë¡œ ì´ë¯¸ íŒŒì‹±ë¬ëŠ”ì§€ í™•ì¸
        if (WebUtils.getNativeRequest(request, MultipartHttpServletRequest.class) != null) {
            //...reqeustê°€ ì´ë¯¸ MultipartHttpServletRequestê°ì²´ ì¼ê²½ìš° ì²˜ë¦¬
        }
        else {
            try {
                //multipartResolver.resolveMultipart(request) í˜¸ì¶œë¨
                return this.multipartResolver.resolveMultipart(request);
            }
            catch (MultipartException ex) {
                //...ìƒëµ
            }
        }
    ```
    requestê°ì²´ê°€ MultipartHttpServletRequestë¡œ ì´ë¯¸ íŒŒì‹±ë¬ëŠ”ì§€ í™•ì¸ í•œ í›„ ì•„ë‹ˆë¼ë©´,  
    `MultipartResolver.resolveMultipart()í˜¸ì¶œ`í•´ì„œ HTTPìš”ì²­ì„ íŒŒì‹±í•˜ê³ , MultipartHttpServletRequest Objectë¡œ ê°ì‹¸ì„œ ë°˜í™˜  
    
    __ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ__  
    ```java
    //this.multipartResolver.resolveMultipart(request)  
    @Override
	public MultipartHttpServletRequest resolveMultipart(HttpServletRequest request) throws MultipartException {
		return new StandardMultipartHttpServletRequest(request, this.resolveLazily);
	}
    ```

    __ì„ì‹œ íŒŒì¼ ìƒì„± ì‹œì __  

    StandardMultipartHttpServletRequestê°ì²´ë¥¼ ìƒì„±í•˜ë©´ì„œ ì„ì‹œ íŒŒì¼ì„ ìƒì„±í•œë‹¤.  
    ì¦‰, `spring.servlet.multipart.resolve-lazily=true`ì„ ê±¸ì§€ ì•ŠëŠ”ì´ìƒ ì´ë¯¸ ì„ì‹œ íŒŒì¼ì€ í•¸ë“¤ëŸ¬ í˜¸ì¶œ ì „ ë©”ëª¨ë¦¬ ë˜ëŠ” ì„ì‹œ í´ë”ì— ì €ì¥ë˜ì–´ ìˆë‹¤.  

    trueë¡œ ì„¤ì •í•  ê²½ìš° í•¸ë“¤ëŸ¬ì—ì„œ reqeustì—ì„œ ê°ì²´ë¥¼ êº¼ë‚´ì˜¬ë•Œ parseParts()ë¥¼ í†µí•´ ë©”ëª¨ë¦¬ ë˜ëŠ” ì„ì‹œ í´ë”ì— íŒŒì¼ì„ ìƒì„±í•œë‹¤.  

    4. MultipartHttpServletRequestë¡œ ë°˜í™˜ëœ ê°ì²´ë¥¼ ì´ìš©í•´ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬

    5. doDispatch() ë§ˆì§€ë§‰ ë¶€ë¶„ì— cleanupMultipart()ê°€ í˜¸ì¶œë˜ì–´ ì—…ë¡œë“œëœ íŒŒì¼ì˜ multipart ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•œ ë¦¬ì†ŒìŠ¤(ì„ì‹œíŒŒì¼orë©”ëª¨ë¦¬)ë“¤ì„ ì •ë¦¬  
    
    ```java
        //dispatch
        finally {
			if (asyncManager.isConcurrentHandlingStarted()) {
				// Instead of postHandle and afterCompletion
				if (mappedHandler != null) {
					mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);
				}
			}
			else {
				// Clean up any resources used by a multipart request.
				if (multipartRequestParsed) {
					cleanupMultipart(processedRequest);
				}
			}
		}
        //cleanupMultipartë©”ì„œë“œ
        protected void cleanupMultipart(HttpServletRequest request) {
		if (this.multipartResolver != null) {
			MultipartHttpServletRequest multipartRequest =
					WebUtils.getNativeRequest(request, MultipartHttpServletRequest.class);
			if (multipartRequest != null) {
                //í˜„ì¬ ì‚¬ìš©ë˜ê³  ìˆëŠ” ë©€í‹°íŒŒíŠ¸ë¦¬ì¡¸ë²„ì˜ cleanupMultipart()í˜¸ì¶œ
				this.multipartResolver.cleanupMultipart(multipartRequest);
			}
		}
	}
        ```
    (ì„ì‹œ ì €ì¥ë˜ëŠ” í´ë”ë¥¼ ë³´ë©´ ë””ë²„ê¹…ì¤‘ì—ëŠ” tmpíŒŒì¼ì´ ë‚¨ì•„ìˆì§€ë§Œ ìš”ì²­ì´ ëë‚œ í›„ì—ëŠ” ì‚­ì œë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.)  

## ì„œë¸”ë¦¿ Part API í™œìš©

Part APIë¥¼ í™œìš©í•˜ì—¬ íŒŒì¼ì„ ì €ì¥í•´ë³´ì.  

- application.properties ì„¤ì •
    ì‹¤ì œ íŒŒì¼ì´ ì €ì¥ë˜ëŠ” ê²½ë¡œë¥¼ ì„¤ì •  
    file.dir=íŒŒì¼ ì—…ë¡œë“œ ê²½ë¡œ ì„¤ì •(ì˜ˆ): /Users/Com1(ì»´í“¨í„°ì´ë¦„)/Desktop/upload/  

    ```properties
    #ì‹¤ì œ íŒŒì¼ì´ ì €ì¥ë˜ëŠ” ê²½ë¡œë¥¼ ì„¤ì •
    file.dir=C://Users/Com1(ì»´í“¨í„°ì´ë¦„)/Desktop/upload/
    ```

- Part API

    - void delete() : ì„ì‹œíŒŒì¼ ì‚­ì œ  
    - String getContentType(): Content-Typeë¡œ ë°˜í™˜  
    - String getHeader(String name) : í•´ë‹¹ í—¤ë”ì˜ ê°’ì„ ë¬¸ìì—´ë¡œ ë°˜í™˜  
    - Collection<String> getHeaderNames() : í—¤ë” ì´ë¦„ë“¤ì„ ë°˜í™˜  
    - Collection<String> getHeaders(String name) : í•´ë‹¹ í—¤ë”ì˜ ê°’ì„ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë°˜í™˜   
    - InputStream getInputStream() : Partì˜ ë°”ë””ë¥¼ Streamìœ¼ë¡œ ë°˜í™˜
	- String getName() : í•„ë“œì˜ ì´ë¦„ê°’ì„ ë°˜í™˜  
    - void write(String fileName) : ì—…ë¡œë“œëœ íŒŒì¼ì„ ë””ìŠ¤í¬ì— ì”€  
    - String getSubmittedFileName() : í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§€ì •í•œ íŒŒì¼ ì´ë¦„ì„ ë°˜í™˜  
    [Part API Docs](https://docs.oracle.com/javaee/7/api/javax/servlet/http/Part.html)

- Controller
    ```java
    @Value("${file.dir}")
    private String fileDir;
    ```
    
    fileDirì— ìœ„ propertiesì— ì„¤ì •í•œ file.dirì˜ ì†ì„±ê°’(ê²½ë¡œ)ì„ ì €ì¥  

    ```java
     @PostMapping("/upload")
    public String saveFileV1(HttpServletRequest request) throws ServletException, IOException {
        log.info("request={}", request);
        String itemName = request.getParameter("itemName");
        log.info("itemName={}", itemName);
        Collection<Part> parts = request.getParts();
        log.info("parts={}", parts);
    ```

    reqeustì˜ Partë¥¼ ê°€ì ¸ì™€ ì»¬ë ‰ì…˜ì— ë‹´ìŒ  
    
    ```java        
        for (Part part : parts) {
            log.info("==== PART ====");
            log.info("name={}", part.getName());
            Collection<String> headerNames = part.getHeaderNames();
            //Partë„ í—¤ë”ì™€ ë°”ë””ê°€ ì¡´ì¬í•œë‹¤.
            for (String headerName : headerNames) {
                log.info("header {}: {}", headerName, part.getHeader(headerName));
            }
    ```
    
    Part.getHeaderë¥¼ í†µí•´ EntityHeader (content-disposition,content-type)ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.  

    ```java
            //Part API í¸ì˜ ë©”ì„œë“œ
            //content-dispositionì˜ filenameì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
            log.info("submittedFileName={}", part.getSubmittedFileName());
            log.info("size={}", part.getSize()); //part body size
    ```

    \- getSubmittedFileName() : Partì˜ íŒŒì¼ì´ë¦„ ë°˜í™˜  
    \- getSize() : Partì˜ ë°”ë”” í¬ê¸° ë°˜í™˜  

    ```java
            //StreamUtilsë¡œ body ë‚´ìš© ë°˜í™˜
            //partì˜ ë°”ë”” ë°ì´í„°ë¥¼ StreamUtils.copyToString()ë©”ì„œë“œë¥¼ í†µí•´ ë¬¸ìì—´ë¡œ ë°˜í™˜ë°›ëŠ”ë‹¤.
            InputStream inputStream = part.getInputStream();
            String body = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);
            inputStream.close();
            //getInputStreamì„ í†µí•´ inputStrem ì‚¬ìš© í›„ ë°˜ë“œì‹œ close() í•´ì£¼ì.
            //close() í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ tmpíŒŒì¼ ì‚­ì œ ì‹œ í•´ë‹¹ tmpíŒŒì¼ì˜ Streamì´ ì—´ë ¤ìˆê¸° ë•Œë¬¸ì— 
            // part.delete()ë¥¼ ìˆ˜í–‰í• ë•Œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œë˜ê³  tmpíŒŒì¼ì´ ê³„ì† ìŒ“ì´ê²Œ ëœë‹¤.
            log.info("body={}", body);

            
            //FileCopyUtils í†µí•´ body ë°˜í™˜ë°›ê¸°
            InputStreamReader in = new InputStreamReader(part.getInputStream(), StandardCharsets.UTF_8);
            String body2 = FileCopyUtils.copyToString(in);
            log.info("body={}",body2);
    ```

    StreamUtils,FileCopyUtilsì„ í†µí•´ partì˜ ë°”ë””ë¥¼ ë¬¸ìì—´ë¡œ ë°˜í™˜ ë°›ì„ ë•Œ,  
    StreamUtilsì˜ ê²½ìš° inputStreamì„ ë‹«ì•„ì£¼ëŠ” ì‘ì—…ì„ ì¶”ê°€ì ìœ¼ë¡œ í•´ì¤˜ì•¼í•œë‹¤.  
    ë§Œì•½ í•˜ì§€ì•ŠëŠ”ë‹¤ë©´ Part ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ ìƒì„±ë˜ëŠ” tmpíŒŒì¼ì´ í˜„ì¬ ìš”ì²­ì´ ì‘ë‹µê¹Œì§€ ë§ˆë¬´ë¦¬ ë  ë•Œ tmpíŒŒì¼ì„ ì‚­ì œí•˜ëŠ” part.delete()ë©”ì„œë“œì—ì„œ inputStreamì´ ì—´ë ¤ ìˆê¸° ë•Œë¬¸ì— ì˜¤ë¥˜ê°€ UncheckedIOException ë°œìƒí•œë‹¤.  
    FileCopyUtilsëŠ” íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜¨ Streamì„ close() í•´ì¤€ë‹¤.  

    ```java        
            //íŒŒì¼ì— ì €ì¥í•˜ê¸°
            //í•´ë‹¹ Partì— filenameì´ ìˆë‹¤ë©´ wrtieë©”ì„œë“œë¥¼ í†µí•´ íŒŒì¼ì„ file.dirë¡œ ì„¤ì •í•œ ê²½ë¡œì— ì €ì¥í•œë‹¤.
            if (StringUtils.hasText(part.getSubmittedFileName())) {
                //getSubmittedFileName()ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ íŒŒì¼ëª…(ì „ì†¡í•œ íŒŒì¼ëª…)ì„ ê°€ì ¸ì˜¨ë‹¤.
                String fullPath = fileDir + part.getSubmittedFileName();
                log.info("íŒŒì¼ ì €ì¥ fullPath={}", fullPath);
                part.write(fullPath);
            }
            part.delete();
        }
        return "upload-form";
    }
    ```

    part.write()ë„ ë‚´ë¶€ì ìœ¼ë¡œ DiskFiteItem.write()ë¥¼ í†µí•´ íŒŒì¼ì„ ì“°ëŠ”ë°,  
    fullPathê²½ë¡œì˜ íŒŒì¼ê³¼ ê°™ì€ì´ë¦„ì˜ íŒŒì¼ì´ ì¡´ì¬í•œë‹¤ë©´ ì‚­ì œ í›„ì—
    File.renameTo()ë¥¼ í˜¸ì¶œí•˜ì—¬ ì„ì‹œíŒŒì¼(tmp)ì„ ë³µì‚¬í•˜ì—¬ ì„¤ì •í•œ ê²½ë¡œ(fullPath)ì— íŒŒì¼ì„ ì“´ë‹¤.  
    (ìµœì¢…ì ìœ¼ë¡œ ë„¤ì´í‹°ë¸Œ ì½”ë“œì¸ private native boolean rename0(File f1, File f2)ê°€ ì‘ë™ë˜ë©´ì„œ tmpíŒŒì¼ì´ ì„¤ì •ê²½ë¡œë¡œ ì´ë™ë˜ëŠ”ê²ƒì„ ë³¼ìˆ˜ìˆë‹¤.  
    ì´ë•Œ í•´ë‹¹ ë©”ì„œë“œë¥¼ 2ë²ˆ í˜¸ì¶œí•  ê²½ìš° tmpíŒŒì¼ì€ ì´ë¯¸ ì„¤ì¡í•œ ê²½ë¡œë¡œ ì´ë™ë˜ì—ˆê¸° ë•Œë¬¸ì— falseë¥¼ ë°˜í™˜í•˜ë©° ì‹¤íŒ¨í•˜ê³  ì²«ë²ˆì§¸ë•Œ ì„±ê³µì ìœ¼ë¡œ ì €ì¥í•œ íŒŒì¼ë„ ì‚­ì œëœë‹¤.)  
    íë¦„ : wrtie("ê²½ë¡œ") í˜¸ì¶œ -> "ê²½ë¡œ"ì˜ ê°™ì€ íŒŒì¼ì¡´ì¬í•˜ë©´ ì‚­ì œ -> tmpíŒŒì¼ì„ "ê²½ë¡œ"ë¡œ ì´ë™(ì˜ë¼ë„£ê¸° ê°œë…)



## ìŠ¤í”„ë§ MultiPartFile í™œìš©

ìŠ¤í”„ë§ì€ MultipartFile ì¸í„°í˜ì´ìŠ¤ë¡œ ë©€í‹°íŒŒíŠ¸ì˜ íŒŒì¼ ì²˜ë¦¬ë¥¼ ì§€ì›í•¨  
ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œì— MultipartFileì„ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.   

- Controller

    ```java
    @PostMapping("/upload")
    public String saveFile(@RequestParam String itemName,
                           @RequestParam MultipartFile file, 
                           HttpServletRequest request) throws IOException {
        log.info("request={}", request);
        log.info("itemName={}", itemName);
        log.info("multipartFile={}", file);
        if (!file.isEmpty()) {
            String fullPath = fileDir + file.getOriginalFilename();
            log.info("íŒŒì¼ ì €ì¥ fullPath={}", fullPath);
            file.transferTo(new File(fullPath));
        }
        return "upload-form";
    }
    ```

- Multipart Form ì „ì†¡

    __ì…ë ¥ í¼__  
    
    ![image](https://github.com/9ony/9ony/assets/97019540/7c5e9a5b-cd12-4bba-9d01-0a7be5b49499)

    __ì „ì†¡ëœ ë°ì´í„°__  
    ```text
    ------WebKitFormBoundaryB1KCpTm8Gi1T4Rqq
    Content-Disposition: form-data; name="itemName"

    Ã­Â…ÂŒÃ¬ÂŠÂ¤Ã­ÂŠÂ¸ ->(í…ŒìŠ¤íŠ¸)
    ------WebKitFormBoundaryB1KCpTm8Gi1T4Rqq
    Content-Disposition: form-data; name="file"; filename="TEST.png"
    Content-Type: image/png

    Â‰PNG
    
    IHDR  Ã¸     Â¼&Ã   sRGB Â®ÃÃ©   gAMA  Â±ÂÃ¼a   	pHYs  Ãƒ  ÃƒÃ‡oÂ¨d  Â±IDATx^Ã­Ã]vÃšHFÃ‘ÂŒÂ‹1FÃƒdLÂ·Ã€Â¤Â·Â–.Â–tÃ½Â±Ã·cÃ¼Â£rÂ‰ÂµÃªÂ¤JÃ˜Â¿Ã¾%t
    ...(ì´ì§„ ë°ì´í„°)
    ------WebKitFormBoundaryB1KCpTm8Gi1T4Rqq--
    ```
    __ë¡œê·¸__  
    ```text
    request=org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@12807ef2
    itemName=í…ŒìŠ¤íŠ¸
    multipartFile=org.springframework.web.multipart.support.StandardMultipartHttpServletRequest$StandardMultipartFile@7048c18f
    íŒŒì¼ ì €ì¥ fullPath=C://Users/Gon/Desktop/upload/TEST.png
    ```

@RequestParamì„ í†µí•´ ê° Partë³„ë¡œ ë“¤ì–´ì˜¨ nameê°’ì˜ ë°ì´í„°ë¥¼ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆê³  Fileë„ ìŠ¤í”„ë§ì˜ MultiPartFile íƒ€ì…ìœ¼ë¡œ ë°›ëŠ”ë‹¤.  
MultipartFileì„ ì´ìš©í•´ ì´ì „ì— ì„œë¸”ë¦¿ Part APIì²˜ëŸ¼ íŒŒì¼ì˜ ì •ë³´ë“¤ì„ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.  
(MultipartFile êµ¬í˜„ì²´ì¸ [StandardMultipartFile](https://docs.spring.io/spring-framework/docs/3.2.2.RELEASE_to_4.0.0.M1/Spring%20Framework%204.0.0.M1/org/springframework/web/multipart/support/StandardMultipartHttpServletRequest.StandardMultipartFile.html)ë„ ë‚´ë¶€ì ìœ¼ë¡œ Partê°ì²´ë¥¼ ì´ìš©í•œë‹¤.)  


ì„œë¸”ë¦¿ì²˜ëŸ¼ requestê°ì²´ì—ì„œ Partë¥¼ ê°€ì ¸ì™€ì„œ ì“°ëŠ”ê²Œ ì•„ë‹Œ MultipartFile í•„ë“œëª…ì„ í†µí•´  RequestParamMethodArgumentResolverê°€ í•´ë‹¹ MultipartFileì„ ì°¾ì•„ì„œ íŒŒì¼ì„ ë°˜í™˜í•´ì¤€ë‹¤.  
ì¦‰, ìŠ¤í”„ë§ì„ ì´ìš©í•˜ë©´ Partë³„ë¡œ í•„ë“œëª…ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•œ íŒŒì¼ì„ ì§ì ‘ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.  


[MultipartFile API Docs](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/multipart/MultipartFile.html)

## íŒŒì¼ ì—…ë¡œë“œ,ë‹¤ìš´ë¡œë“œ ì˜ˆì œ

ìœ ì €ê°€ ì›¹ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ë•Œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜, ë‹¤ìš´ë¡œë“œí• ë•Œì— ìœ ì €ê°€ ì§ì ‘ì˜¬ë¦° íŒŒì¼ëª…ì´ ì˜¬ë¼ê°„ë‹¤.  
í•˜ì§€ë§Œ ì„œë²„ì—ì„œëŠ” í•´ë‹¹ ì´ë¦„ìœ¼ë¡œ íŒŒì¼ì„ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.  
ë§Œì•½ ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì€ ìƒí™©ì´ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì.  

![image](https://github.com/9ony/9ony/assets/97019540/f4b2e1f2-b7f3-4686-9758-01674f3d9618)

1ë²ˆì˜ ê²½ìš° UserAê°€ Test.pngë¼ëŠ” íŒŒì¼ì„ ë³´ëƒˆë‹¤.  
ê·¸ ì´í›„ UserBê°€ Test.pngë¼ëŠ” ë‚´ìš©ì´ ë‹¤ë¥´ì§€ë§Œ íŒŒì¼ëª…ì´ ê°™ì€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí–ˆì„ë•Œ,  
ìœ„ì— part.write()ë¥¼ í†µí•´ íŒŒì¼ì„ ì“°ê²Œë˜ëŠ”ë° ì´ë•Œ í•´ë‹¹ ê²½ë¡œì— ì—…ë¡œë“œí•  íŒŒì¼ëª…ì˜ íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ì‚­ì œí›„ì— í˜„ì¬ ìš”ì²­ìœ¼ë¡œ ì˜¨ ì—…ë¡œë“œ íŒŒì¼ì˜ ì„ì‹œíŒŒì¼ì„ ì €ì¥í•˜ëŠ” ë™ì‘ì„ ê±°ì¹œë‹¤.  

ì¦‰, í´ë¼ì´ì–¸íŠ¸ê°€ ì—…ë¡œë“œí•œ íŒŒì¼ëª…ìœ¼ë¡œ ì„œë²„ì— íŒŒì¼ì„ ì €ì¥í•˜ê²Œ ëœë‹¤ë©´ UserAëŠ” ìì‹ ì˜ íŒŒì¼ì„ ì¡°íšŒí–ˆì„ ë•Œ ì´ë¯¸ì§€ê°€ ë°”ë€Œì–´ ìˆì„ ê²ƒì´ë‹¤.  

ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ê°€ ì—…ë¡œë“œí•œ ì‹¤ì œ íŒŒì¼ëª…ê³¼ ì„œë²„ì— ì €ì¥í•  íŒŒì¼ëª…ì„ êµ¬ë¶„ì‹œì¼œì£¼ì–´ì•¼ í•œë‹¤.  

- DBì—­í• ì„ í•  ItemRepository.Class  
    ```java
    @Repository
    public class ItemRepository {
        //DB ì—­í• 
        private final Map<Long, Item> store = new HashMap<>();
        private AtomicLong sequence = new AtomicLong();

        public Item save(Item item){
            item.setId(sequence.incrementAndGet());
            store.put(item.getId(),item);
            return item;
        }

        public Item findById(Long id){
            return store.get(id);
        }
        
    }
    ```

- Item ê°ì²´  
    Item Entity  
    ```java
    @Data
    public class Item {
        // Entity
        private Long id; //ìƒí’ˆë²ˆí˜¸
        private String itemName; //ìƒí’ˆì´ë¦„
        private UploadFile attachFile;  //ì²¨ë¶€íŒŒì¼
        private List<UploadFile> imageFiles; //ì´ë¯¸ì§€íŒŒì¼ (ë‹¤ìˆ˜)

    }
    ```

- ItemForm (DTO) 
    Formì— ì‚¬ìš©í•  DTO
    ```java
    @Data
    public class ItemForm {
        //ì•„ì´í…œ ì—…ë¡œë“œ í¼ì— ì‚¬ìš©ë  ê°ì²´ (DTO)
        private Long id; //ìƒí’ˆë²ˆí˜¸
        private String itemName; //ìƒí’ˆì´ë¦„
        private MultipartFile attachFile;  //ì²¨ë¶€íŒŒì¼
        private List<MultipartFile> imageFiles; //ì´ë¯¸ì§€íŒŒì¼
    }
    ```
    â— MutliPartfileì„ì„ ì£¼ì˜í•˜ì

- UploadFile 
    ì—…ë¡œë“œ íŒŒì¼ ì •ë³´ë¥¼ ì €ì¥í•  ê°ì²´
    ```java
    @Data
    public class UploadFile {

        private String uploadFileName; //ì—…ë¡œë“œ ì‹œ íŒŒì¼ì´ë¦„
        private String storeFileName; //DBì— ì €ì¥í•  íŒŒì¼ì´ë¦„

        public UploadFile(String uploadFileName, String storeFileName) {
            this.uploadFileName = uploadFileName;
            this.storeFileName = storeFileName;
        }

    }
    ```

- FileStore 
    íŒŒì¼ ì €ì¥ê´€ë ¨ëœ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§  
    ```java
    @Service
    public class FileStore {

        @Value("${file.dir}")
        private String fileDir;
        
        // íŒŒì¼ì´ë¦„ì„ ë°›ì•„ì„œ í•´ë‹¹ íŒŒì¼ ì „ì²´ê²½ë¡œë¥¼ ë°˜í™˜
        public String getFullPath(String filename) {
            return fileDir + filename;
        }

        // íŒŒì¼ ì €ì¥ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œ
        // MiltipartFileì„ ë°›ì•„ì„œ UploadFileë¡œ ë°˜í™˜
        // í•´ë‹¹ ë©”ì„œë“œëŠ” ë‹¤ìˆ˜ì˜ íŒŒì¼ì„ ë°›ì•„ ì €ì¥í•¨
        public List<UploadFile> storeFiles(List<MultipartFile> multipartFiles)
                throws IOException {
            List<UploadFile> storeFileResult = new ArrayList<>();
            for (MultipartFile multipartFile : multipartFiles) {
                if (!multipartFile.isEmpty()) {
                    storeFileResult.add(storeFile(multipartFile));
                }
            }
            return storeFileResult;
        }

        // ë‹¨ì¼íŒŒì¼ ì €ì¥ ì²˜ë¦¬
        public UploadFile storeFile(MultipartFile multipartFile) throws IOException
        {
            if (multipartFile.isEmpty()) {
                return null;
            }
            String originalFilename = multipartFile.getOriginalFilename();
            // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚¸ íŒŒì¼ëª… TEST.png

            String storeFileName = createStoreFileName(originalFilename);
            // ì„œë²„ì— ì €ì¥í•  íŒŒì¼ëª… --> UUID

            multipartFile.transferTo(new File(getFullPath(storeFileName)));
            //transferToë©”ì„œë“œë¥¼ í†µí•´ íŒŒì¼ì„ ì €ì¥ íŒŒì¼ëª…ì€ UUID.í™•ì¥ì
            
            return new UploadFile(originalFilename, storeFileName);
        }
        
        //ì„œë²„ì—ì„œ ì‚¬ìš©í•  íŒŒì¼ëª…
        //ì„œë²„ ë‚´ë¶€ì—ì„œ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ëª…ì€ ì„œë¡œ ì¶©ëŒí•˜ì§€ ì•Šê¸°ìœ„í•´ UUIDë¥¼ ì‚¬ìš©
        //ìµœì¢…ì ìœ¼ë¡œ "UUID" +".í™•ì¥ì" ë°˜í™˜
        private String createStoreFileName(String originalFilename) {
            String ext = extractExt(originalFilename);
            String uuid = UUID.randomUUID().toString();
            return uuid + "." + ext;
        }
        
        //í™•ì¥ì ì¶”ì¶œ ë©”ì„œë“œ
        private String extractExt(String originalFilename) {
            int pos = originalFilename.lastIndexOf(".");
            return originalFilename.substring(pos + 1);
        }

    }
    ```

    - getFullPath("íŒŒì¼ëª…") : íŒŒì¼ì˜ ì €ì¥ ê²½ë¡œë¥¼ ë°˜í™˜í•œë‹¤.  
    - storeFile(MultipartFile) : íŒŒì¼ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œ  
    - storeFiles(List<MultipartFile>) : ë‹¤ìˆ˜ì˜ íŒŒì¼ì„ ë°›ì„ ì‹œ ë£¨í”„ë¥¼ ëŒë©° storeFile(MultipartFile) í˜¸ì¶œí•˜ì—¬ UploadFileê°ì²´ ìƒì„± í›„ Listë¡œ ë°˜í™˜  
    - createStoreFileName("ì›ë³¸ íŒŒì¼ëª…") : ì›ë³¸íŒŒì¼ëª…ì˜ í™•ì¥ìë¥¼ ì¶”ì¶œí•˜ê³  UUID+.í™•ì¥ìë¡œ ì„œë²„ì— ì €ì¥í•  íŒŒì¼ëª…ì„ ë°˜í™˜  
    - extractExt("ì›ë³¸ íŒŒì¼ëª…") : í™•ì¥ìë¥¼ í˜¸ì¶œí•˜ëŠ” ë©”ì„œë“œ  

- Controller

    ```java
    @Slf4j
    @RequiredArgsConstructor
    @Controller
    public class ItemController {

        private final ItemRepository itemRepository;
        private final FileStore fileStore;

        @GetMapping("/items/new")
        public String newItem(@ModelAttribute ItemForm form) {
            return "item-form";
        }

        @PostMapping("/items/new")
        public String saveItem(@ModelAttribute ItemForm form, RedirectAttributes redirectAttributes) throws IOException {
            UploadFile attachFile = fileStore.storeFile(form.getAttachFile());
            List<UploadFile> storeImageFiles = fileStore.storeFiles(form.getImageFiles());
            //ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            Item item = new Item();
            item.setItemName(form.getItemName());
            item.setAttachFile(attachFile);
            item.setImageFiles(storeImageFiles);
            itemRepository.save(item);
            redirectAttributes.addAttribute("itemId", item.getId());
            return "redirect:/items/{itemId}";
        }

        @GetMapping("/items/{id}")
        public String items(@PathVariable Long id, Model model) {
            Item item = itemRepository.findById(id);
            model.addAttribute("item", item);
            return "item-view";
        }

        @ResponseBody
        @GetMapping("/images/{filename}")
        public Resource downloadImage(@PathVariable String filename) throws MalformedURLException {
            return new UrlResource("file:" + fileStore.getFullPath(filename));
        }

        @GetMapping("/attach/{itemId}")
        public ResponseEntity<Resource> downloadAttach(@PathVariable Long itemId) throws MalformedURLException {
            Item item = itemRepository.findById(itemId);
            String storeFileName = item.getAttachFile().getStoreFileName();
            String uploadFileName = item.getAttachFile().getUploadFileName();
            UrlResource resource = new UrlResource("file:" +
                    fileStore.getFullPath(storeFileName));
            log.info("resource = {}",resource);
            log.info("uploadFileName={}", uploadFileName);
            String encodedUploadFileName = UriUtils.encode(uploadFileName, StandardCharsets.UTF_8);
            String contentDisposition = "attachment; filename=\"" + encodedUploadFileName + "\"";
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, contentDisposition)
                    .body(resource);
        }
    }
    
    ```

    - POST "/items/new"  
        í¼ ì „ì†¡ì„ í†µí•´ ìš”ì²­ì˜¨ ë°ì´í„°ë¡œ ì›ë³¸ íŒŒì¼ëª…ì„ ì´ìš©í•˜ì—¬ FileStoreë¥¼ í†µí•´ UploadFileê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë§Œë“  Itemê°ì²´ë¥¼ DB(ItemRespository)ì— ì €ì¥í•œë‹¤.  
    
    - GET "/items/{id}"
        í•´ë‹¹ idì˜ ìƒí’ˆì˜ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” í™”ë©´ìœ¼ë¡œ ì´ë™  

    - Get "/images/{filename}"  
        í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ì— ì´ë¯¸ì§€ë¥¼ ìš”ì²­  
        `Resource`ë¥¼ ì¶”ìƒí™”í•œ ê°ì²´ë¥¼ í†µí•´ í•´ë‹¹ì„œë²„ì˜ ë¡œì»¬íŒŒì¼ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë©°, Resourceë¥¼ ë¦¬í„´í•˜ê²Œë˜ë©´ Resourceë¥¼ ì²˜ë¦¬í•˜ëŠ” ë©”ì„¸ì§€ ì»¨ë²„í„°ì—ì„œ resourceì˜ InputStreamì„ ë°”ë””ì— ë‹´ì•„ ì‘ë‹µí•œë‹¤.  
        Resource ì¸í„°í˜ì´ìŠ¤ê°€ InputSteramResourceë¥¼ ìƒì†ë°›ì•„ì„œ getInputStreamì„ í†µí•´ ì‘ë‹µ ì‹œ ì»¨ë²„í„°ì—ì„œ InputStreamì„ ì“¸ ìˆ˜ ìˆë‹¤.  

    - Get "/attach/{itemId}"  
        íŒŒì¼ë„ ì´ë¯¸ì§€ì™€ ë™ì¼í•˜ê²Œ Resourceë¥¼ ë°˜í™˜í•˜ê²Œ ë˜ëŠ”ë° ì°¨ì´ì ìœ¼ë¡œëŠ” 
        í•´ë‹¹ ìš”ì²­ì€ íŒŒì¼ì„ ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì•¼ í•˜ëŠ”ë° Content-Disposition í—¤ë”ì— ì†ì„±ê°’ìœ¼ë¡œ attachment;ì™€ encodedUploadFileName(ì—…ë¡œë“œ ë‹¹ì‹œ ì‹¤ì œ íŒŒì¼ëª…)ì„  filenameì˜ ê°’ìœ¼ë¡œ ë„£ì–´ì£¼ëŠ” ê²ƒì´ë‹¤.  
        attachment ì†ì„±ì„ ì£¼ê²Œë˜ë©´ í•´ë‹¹ ë°”ë””ì˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ê²Œ ë˜ê³  filename ì†ì„±ì˜ ê°’ì„ íŒŒì¼ì´ë¦„ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ê²Œëœë‹¤.  

### íŒŒì¼ ë°ì´í„°ë¥¼ addResourceHandlers ì„¤ì •ìœ¼ë¡œ ì‘ë‹µí•˜ëŠ” ë°©ë²•

ìœ„ ì˜ˆì œì—ì„œ UrlResourceë¥¼ í†µí•´ íŒŒì¼ì„ ì ‘ê·¼í•´ì„œ ì´ì§„ ë°ì´í„°ë¥¼ ì‘ë‹µí•´ì£¼ì—ˆë‹¤.  
í•˜ì§€ë§Œ ìœ„ ë°©ë²•ë§ê³  ìš°ë¦¬ê°€ ì •ì ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•˜ë˜ ë°©ë²•ì„ ë– ì˜¬ë ¤ë³´ì.  
resources/static/ ê²½ë¡œì— index.htmlì„ ë§Œë“¤ì–´ ë†“ì•˜ë‹¤ë©´ í•´ë‹¹ ì£¼ì†Œë§Œ ì…ë ¥í•˜ë©´ index.htmlì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  

ì´ë¯¸ì§€ë„ ë§ˆì°¬ê°€ì§€ë¡œ `<img src="/image.png"/>` ì´ë¯¸ì§€íƒœê·¸ë¥¼ ì‘ì„±í›„ì— staticí´ë”ì— í•´ë‹¹íŒŒì¼ëª…ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë„£ì–´ë³´ë©´ ì´ë¯¸ì§€ê°€ ì¶œë ¥ë  ê²ƒì´ë‹¤.   
ì´ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì •ì ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•´ì£¼ëŠ” ê²½ë¡œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì •í•´ë†“ì•˜ê¸° ë•Œë¬¸ì¸ë°, index.htmlì„ ì…ë ¥í•˜ë©´ staticí´ë”ì—ì„œ index.htmlì„ ì°¾ëŠ” ê²ƒì´ê³  image.pngë„ ë§ˆì°¬ê°€ì§€ì´ë‹¤.  

ì´ë•Œ ì •ì ë¦¬ì†ŒìŠ¤ ì²˜ë¦¬ì— `ResourceHttpRequestHandler`ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë°, 
ì•„ë˜ì²˜ëŸ¼ WebMvcConfigurerì— í•¸ë“¤ëŸ¬ì™€ í•´ë‹¹ ë§¤í•‘ëœ í•¸ë“¤ëŸ¬ ê²½ë¡œë¡œ ìš”ì²­ì´ ì˜¤ë©´ ì–´ëŠ ê²½ë¡œì—ì„œ íŒŒì¼ì„ ì¡°íšŒí• ì§€ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.  

- WebMvcConfigurer ì¶”ê°€

    ```java
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/images2/**")
                .addResourceLocations("file:///C://Users/ì»´í“¨í„°ì´ë¦„/Desktop/upload/");
    }
    ```

    addResourceHandler : í•¸ë“¤ëŸ¬ ë§¤í•‘ ì£¼ì†Œ ì„¤ì •  
    addResourceLocations : ë§¤í•‘ëœ ì£¼ì†Œë¡œ ìš”ì²­ì´ ì˜¬ ì‹œ ì‹¤ì œ íŒŒì¼ê²½ë¡œ prefix  
    [ì´ ì™¸ì˜ ì¶”ê°€ ì˜µì…˜](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/ResourceHandlerRegistration.html)  

    1. GET /images2/imageTEST.png ë¡œ ìš”ì²­ í›„  
    2. í•´ë‹¹ ì£¼ì†Œë¡œ ë§¤í•‘ëœ í•¸ë“¤ëŸ¬ê°€ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œ `/images2/**`ì´ë¯€ë¡œ ResourceHttpRequestHandlerê°€ ì‹¤í–‰ ë¨  
    (ìš°ì„ ìˆœìœ„ê°€ ë‚®ìŒ ì¦‰, ì»¨íŠ¸ë¡¤ëŸ¬ì— /images2/**ì— í•´ë‹¹ë˜ëŠ” í•¸ë“¤ëŸ¬ê°€ ìˆìœ¼ë©´ ì‹¤í–‰ì´ ì•ˆë¨ )  
    3. file:///C://Users/ì»´í“¨í„°ì´ë¦„/Desktop/upload/images2/imageTEST.png íŒŒì¼ì„ ì°¾ì•„ì„œ ë°˜í™˜í•˜ê²Œ ë˜ëŠ”ê²ƒì´ë‹¤.  

ë‹¨ íŒŒì¼ ë‹¤ìš´ë¡œë“œê°™ì€ ê²½ìš° Content-Disposition í—¤ë”ì— ì†ì„±ê°’ì„ ë„£ì–´ì¤˜ì•¼ í•˜ëŠ”ë° addResourceHandlersë¡œëŠ” í•´ê²°í•˜ëŠ” ë°©ë²•ì´ ê¹Œë‹¤ë¡­ê³ , ë˜ ê¶Œí•œë³„ë¡œ ì´ë¯¸ì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ëŒ€ìƒì„ ì •í• ë•Œì—ë„ í•„í„°ë‚˜ ì¸í„°ì…‰í„°ë¡œ ì²˜ë¦¬í•´ë„ ë˜ì§€ë§Œ ìœ„ ì˜ˆì œì²˜ëŸ¼ ë³„ë„ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì„œ ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•˜ëŠ” ê²½ìš°ë„ ìˆë‹¤.  

`addResourceHandlers`ë¡œ ëŒ€ë¶€ë¶„ì˜ ì •ì ë¦¬ì†ŒìŠ¤ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ ë¡œì§ì„ ì¶”ê°€í•˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œ ë“± íŠ¹ë³„í•œ ê²½ìš° ì»¤ìŠ¤í…€ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•˜ë©´ ë ê²ƒ ê°™ë‹¤.  

### ì •ë¦¬

multipart/form-dataë¥¼ í†µí•´ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.  
partë³„ë¡œ content-typeì´ ë‹¤ë¥¸ ë¶„ë¦¬ëœ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.  
ì„œë²„ì—ì„œ Part APIë‚˜ ìŠ¤í”„ë§ì—ì„œ MultipartResolverê°€ ë³µì¡í•œ ìš”ì²­ì„ ì²˜ë¦¬ í•´ì¤€ë‹¤.  
ì—…ë¡œë“œ íŒŒì¼ì„ ì €ì¥í•  ë•Œì—ëŠ” ì‹¤ì œíŒŒì¼ëª…ê³¼ dbì™€ ë¡œì»¬ì— ì €ì¥í•  íŒŒì¼ëª…ì„ ë¶„ë¦¬í•´ì£¼ì–´ì•¼ í•œë‹¤.  
> íŒŒì¼ëª…ì´ ê²¹ì¹˜ê²Œ ëœë‹¤ë©´ ê¸°ì¡´ ë™ì¼ íŒŒì¼ëª… ì‚­ì œ í›„ ì €ì¥í•˜ê¸° ë•Œë¬¸!!
íŒŒì¼ì„ ì‘ë‹µí•  ì‹œì—ëŠ” Resource ê°ì²´ë¥¼ ë¦¬í„´í•´ì£¼ë©´ ë©”ì„¸ì§€ ì»¨ë²„í„°ê°€ ì´ë¥¼ ì´ì§„ë°ì´í„°ë¡œ ë³€í™˜ì‹œì¼œ ì‘ë‹µí•´ì¤€ë‹¤.  
ë‹¤ìš´ë¡œë“œê°€ ì•„ë‹Œ ì¼ë°˜ì ì¸ íŒŒì¼,ì´ë¯¸ì§€ ë“±ì„ ì²˜ë¦¬ ì‹œ `addResourceHandler`ë¥¼ í™œìš©í•˜ì.  
